$(document).on('turbolinks:load', function() {

  if(isHandshakePath(location.pathname)){
    var pathId = location.pathname.replace( /^\D+/g, '');
      App['challenge' + pathId] = App.cable.subscriptions.create({channel: 'HandshakesChannel', room: pathId}, {
         connected: function() {

        },

        received: function(data) {
          checkHandshakes(pathId, data.handshakes);
            $("[data-challenge='" + this.challengeId + "']").css("background-color", "green");
            return $("[data-challenge='" + this.challengeId + "']").append(data.message);
        },

        setChallengeId: function(challengeId) {
          this.challengeId = challengeId;
        }
      });
    submitNewMessage();
  }
});

function isHandshakePath(path){
  return (path.match(/^\D+/) == "/handshakes/");
};

function checkHandshakes(challenge_id, shooken) {
  if(shooken >= 2){
    return location.replace("/challenges/" + challenge_id + "/edit");
  }
};

function submitNewMessage(){
  $('a.the-shake-button').on('click', function(event) {
        var idOfChallengeRoom = ($(this).closest('div').attr('data-challenge'));
        $(this).hide()
        App['challenge' + idOfChallengeRoom].setChallengeId(idOfChallengeRoom);
        App['challenge' + idOfChallengeRoom].send({message: idOfChallengeRoom});
       return false;
    });
}
